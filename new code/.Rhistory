# Boxplot: ServeDepth
ggplot(subset_m_second, aes(x = ServeDepth, y = ElapsedSeconds)) +
geom_boxplot() +
labs(title = "Seconds Elapsed by Serve Depth (Males)",
x = "Serve Depth",
y = "Seconds Elapsed") +
theme_minimal()
ggsave("../images/male_time_vs_servedepth.png", bg = "white", width = 7, height = 5, units = "in")
# Boxplot: Server wElo vs. ServeWidth
ggplot(subset_f_second, aes(x = ServeWidth, y = ElapsedSeconds)) +
geom_boxplot() +
labs(title = "Server wElo by Serve Width (Females)",
x = "Serve Width",
y = "Seconds Elapsed") +
theme_minimal()
# Boxplot: Server wElo vs. ServeWidth
ggplot(subset_f_second, aes(x = ServeWidth, y = ElapsedSeconds)) +
geom_boxplot() +
labs(title = "Seconds Elapsed by Serve Width (Females)",
x = "Serve Width",
y = "Seconds Elapsed") +
theme_minimal()
ggsave("../images/female_time_vs_servewidth.png", bg = "white", width = 7, height = 5, units = "in")
# Boxplot: Server wElo vs. ServeDepth
ggplot(subset_f_second, aes(x = ServeDepth, y = ElapsedSeconds)) +
geom_boxplot() +
labs(title = "Seconds Elapsed by Serve Depth (Females)",
x = "Serve Depth",
y = "Seconds Elapsed") +
theme_minimal()
ggsave("../images/female_time_vs_servedepth.png", bg = "white", width = 7, height = 5, units = "in")
## new elapsedtime eda
subset_m <- subset_m[ElapsedSeconds < 28800] # 8 hours
subset_f <- subset_f[ElapsedSeconds < 21600] # 6 hours
subset_m_second <- subset_m[ServeNumber == 2]
subset_f_second <- subset_f[ServeNumber == 2]
m_second_elapsed <- subset_m_second %>%
select(ElapsedSeconds, speed_ratio)
cor(m_second_elapsed$ElapsedSeconds, m_second_elapsed$speed_ratio, use = "complete.obs") # -0.05 ish
ggplot(m_second_elapsed, aes(x = ElapsedSeconds, y = speed_ratio)) +
geom_point(alpha = 0.3) +
geom_smooth(method = "lm", se = FALSE, color = "red") +
labs(title = "Seconds Elapsed (Match) vs. Second Serve Speed Ratio -- Males (corr ~ -0.05)",
x = "Seconds Elapsed",
y = "Second Serve Speed Ratio (compared to avg first serve speed)") +
theme_minimal()
cor(subset_m_second$importance, subset_m_second$speed_ratio, use = "complete.obs") # -0.05 ish
ggplot(subset_m_second, aes(x = importance, y = speed_ratio)) +
geom_point(alpha = 0.3) +
geom_smooth(method = "lm", se = FALSE, color = "red") +
labs(title = "Point Importance vs. Second Serve Speed Ratio -- Males (corr ~ 0.04)",
x = "Point Importance",
y = "Second Serve Speed Ratio (compared to avg first serve speed)") +
theme_minimal()
ggsave("../images/male_importance_vs_second_serve_speed.png", bg = "white",
width = 8, height = 6, units = "in")
cor(subset_f_second$importance, subset_f_second$speed_ratio, use = "complete.obs") # -0.067 ish
cor(subset_f_second$importance, subset_f_second$speed_ratio, use = "complete.obs") # 0.05 ish
ggplot(subset_f_second, aes(x = importance, y = speed_ratio)) +
geom_point(alpha = 0.3) +
geom_smooth(method = "lm", se = FALSE, color = "red") +
labs(title = "Point Importance vs. Second Serve Speed Ratio -- Females (corr ~ 0.05)",
x = "Point Importance",
y = "Second Serve Speed Ratio (compared to avg first serve speed)") +
theme_minimal()
ggsave("../images/male_importance_vs_servewidth.png", bg = "white", width = 7, height = 5, units = "in")
# Boxplot: ServeWidth
ggplot(subset_m_second, aes(x = ServeWidth, y = importance)) +
geom_boxplot() +
labs(title = "Importance by Serve Width (Males)",
x = "Serve Width",
y = "Importance") +
theme_minimal()
ggsave("../images/male_importance_vs_servewidth.png", bg = "white", width = 7, height = 5, units = "in")
# Boxplot: ServeDepth
ggplot(subset_m_second, aes(x = ServeDepth, y = importance)) +
geom_boxplot() +
labs(title = "Importance by Serve Depth (Males)",
x = "Serve Depth",
y = "Importance") +
theme_minimal()
score_importance_dtmc <- as.data.table(read.csv("../data/score_importance_dtmc.csv"))
View(score_importance_dtmc)
# Boxplot: ServeDepth
ggplot(subset_m_second, aes(x = ServeDepth, y = importance)) +
geom_boxplot() +
labs(title = "Importance by Serve Depth (Males)",
x = "Serve Depth",
y = "Importance") +
theme_minimal()
ggsave("../images/male_importance_vs_servedepth.png", bg = "white", width = 7, height = 5, units = "in")
# Boxplot: ServeWidth
ggplot(subset_f_second, aes(x = ServeWidth, y = importance)) +
geom_boxplot() +
labs(title = "Importance by Serve Width (Females)",
x = "Serve Width",
y = "Seconds Elapsed") +
theme_minimal()
ggsave("../images/female_importance_vs_servewidth.png", bg = "white", width = 7, height = 5, units = "in")
# Boxplot: ServeDepth
ggplot(subset_f_second, aes(x = ServeDepth, y = importance)) +
geom_boxplot() +
labs(title = "Importance by Serve Depth (Females)",
x = "Serve Depth",
y = "Importance") +
theme_minimal()
ggsave("../images/female_importance_vs_servedepth.png", bg = "white", width = 7, height = 5, units = "in")
write.csv(subset_m, "../data/wimbledon_subset_m_09.csv", row.names = FALSE)
write.csv(subset_f, "../data/wimbledon_subset_f_09.csv", row.names = FALSE)
rm(list=ls())
# install.packages("welo")
library(welo)
library(tidyverse)
library(data.table)
wimbledon_2011 <- as.data.table(read.csv("../data/wimbledon_2011_combined.csv"))
wimbledon_2012 <- as.data.table(read.csv("../data/wimbledon_2012_combined.csv"))
wimbledon_2013 <- as.data.table(read.csv("../data/wimbledon_2013_combined.csv"))
wimbledon_2014 <- as.data.table(read.csv("../data/wimbledon_2014_combined.csv"))
wimbledon_2015 <- as.data.table(read.csv("../data/wimbledon_2015_combined.csv"))
wimbledon_2016 <- as.data.table(read.csv("../data/wimbledon_2016_combined.csv"))
wimbledon_2017 <- as.data.table(read.csv("../data/wimbledon_2017_combined.csv"))
wimbledon_2018 <- as.data.table(read.csv("../data/wimbledon_2018_combined.csv"))
wimbledon_2019 <- as.data.table(read.csv("../data/wimbledon_2019_combined.csv"))
wimbledon_2021 <- as.data.table(read.csv("../data/wimbledon_2021_combined.csv"))
wimbledon_2022 <- as.data.table(read.csv("../data/wimbledon_2022_combined.csv"))
wimbledon_2023 <- as.data.table(read.csv("../data/wimbledon_2023_combined.csv"))
wimbledon_2024 <- as.data.table(read.csv("../data/wimbledon_2024_combined.csv"))
names(wimbledon_2015)
selected_cols <- c("P1Score", "P2Score", "PointServer", "PointWinner", "GameWinner")
wimbledon_combined <- rbindlist(lapply(
list(wimbledon_2011, wimbledon_2012, wimbledon_2013, wimbledon_2014, wimbledon_2015, wimbledon_2016,
wimbledon_2017, wimbledon_2018, wimbledon_2019, wimbledon_2021, wimbledon_2022, wimbledon_2023, wimbledon_2024),
function(dt) dt[, ..selected_cols]
)) %>%
mutate(
P1Score = as.character(P1Score),
P2Score = as.character(P2Score),
PointServer = as.integer(PointServer),
PointWinner = as.integer(PointWinner),
GameWinner = as.integer(GameWinner),
server_score = if_else(PointServer == 1, P1Score, P2Score),
returner_score = if_else(PointServer == 1, P2Score, P1Score),
state = paste(server_score, returner_score, sep = "-")
) %>%
filter(!is.na(P1Score), !is.na(P2Score), !is.na(PointServer), !is.na(PointWinner), !is.na(GameWinner))
# remove last row in wimbledon_combined
wimbledon_combined <- wimbledon_combined[-nrow(wimbledon_combined), ]
# Prepare and clean the data
df <- wimbledon_combined %>%
mutate(
server = if_else(PointServer == 1, "P1", "P2"),
server_won_point = if_else((server == "P1" & PointWinner == 1) |
(server == "P2" & PointWinner == 2), TRUE, FALSE),
game_winner_is_server = if_else((server == "P1" & GameWinner == 1) |
(server == "P2" & GameWinner == 2), 1, 0)
) %>%
filter(state %in% c("0-0", "15-0", "30-0", "40-0",
"0-15", "0-30", "0-40",
"15-15", "30-15", "40-15",
"15-30", "30-30", "40-30",
"15-40", "30-40", "40-40",
"40-AD", "AD-40"))
View(df)
# Prepare and clean the data
df <- wimbledon_combined %>%
mutate(
server = if_else(PointServer == 1, "P1", "P2"),
server_won_point = if_else((server == "P1" & PointWinner == 1) |
(server == "P2" & PointWinner == 2), TRUE, FALSE),
game_winner_is_server = if_else((server == "P1" & GameWinner == 1) |
(server == "P2" & GameWinner == 2), 1, 0)
) %>%
filter(state %in% c("0-0", "15-0", "30-0", "40-0",
"0-15", "0-30", "0-40",
"15-15", "30-15", "40-15",
"15-30", "30-30", "40-30",
"15-40", "30-40", "40-40",
"40-AD", "AD-40")) %>%
filter(PointServer %in% c(1, 2))
View(df)
# Step 1: Add a unique game ID (based on runs of "0-0" score)
df <- df %>%
mutate(new_game = (state == "0-0")) %>%
mutate(game_id = cumsum(new_game))
# Step 2: Create a lookup table with the GameWinner for each game_id
game_winners <- df %>%
filter(state == "0-0") %>%
select(game_id, GameWinner)
# Shift GameWinner up by one row (so it applies to the previous game)
game_winners <- game_winners %>%
mutate(GameWinner = lead(GameWinner))
# player 1 won the last game (from wimbledon_combined before removoing last row)
game_winners[nrow(game_winners), "GameWinner"] <- 1
# Step 3: Join back to assign GameWinner to all points in the same game
df <- df %>%
select(-GameWinner) %>%  # remove old GameWinner (0s)
left_join(game_winners, by = "game_id")  # assign correct GameWinner
df <- df %>%
mutate(
game_winner_is_server = if_else((server == "P1" & GameWinner == 1) |
(server == "P2" & GameWinner == 2), 1, 0)
)
View(df)
# Prepare and clean the data
df <- wimbledon_combined %>%
mutate(
server = if_else(PointServer == 1, "P1", "P2"),
server_won_point = if_else((server == "P1" & PointWinner == 1) |
(server == "P2" & PointWinner == 2), TRUE, FALSE),
game_winner_is_server = if_else((server == "P1" & GameWinner == 1) |
(server == "P2" & GameWinner == 2), 1, 0)
) %>%
filter(state %in% c("0-0", "15-0", "30-0", "40-0",
"0-15", "0-30", "0-40",
"15-15", "30-15", "40-15",
"15-30", "30-30", "40-30",
"15-40", "30-40", "40-40",
"40-AD", "AD-40"))
# Step 1: Add a unique game ID (based on runs of "0-0" score)
df <- df %>%
mutate(new_game = (state == "0-0")) %>%
mutate(game_id = cumsum(new_game))
# Step 2: Create a lookup table with the GameWinner for each game_id
game_winners <- df %>%
filter(state == "0-0") %>%
select(game_id, GameWinner)
# Shift GameWinner up by one row (so it applies to the previous game)
game_winners <- game_winners %>%
mutate(GameWinner = lead(GameWinner))
# player 1 won the last game (from wimbledon_combined before removoing last row)
game_winners[nrow(game_winners), "GameWinner"] <- 1
# Step 3: Join back to assign GameWinner to all points in the same game
df <- df %>%
select(-GameWinner) %>%  # remove old GameWinner (0s)
left_join(game_winners, by = "game_id")  # assign correct GameWinner
df <- df %>%
mutate(
game_winner_is_server = if_else((server == "P1" & GameWinner == 1) |
(server == "P2" & GameWinner == 2), 1, 0)
)
df <- df %>%
filter(PointServer %in% c(1, 2))
View(df)
# Get all transitions where the current score is known
# and filter where the server had a chance to win
df_scores <- df %>%
filter(!is.na(state)) %>%
group_by(state, server_won_point) %>%
summarise(
n = n(),
server_win_game = sum(game_winner_is_server, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(prob_win_game = server_win_game / n)
# Pivot wider so we can calculate importance
importance_df <- df_scores %>%
select(state, server_won_point, prob_win_game) %>%
pivot_wider(names_from = server_won_point, values_from = prob_win_game,
names_prefix = "Pwin_") %>%
mutate(importance = abs(Pwin_TRUE - Pwin_FALSE)) %>%
arrange(desc(importance))
View(importance_df)
View(df_scores)
View(df)
df_scores <- df %>%
filter(!is.na(state)) %>%
group_by(state, server_won_point) %>%
summarise(
n = n())
View(df)
View(df_scores)
## filter to just rows where state is 0-15
df_0_15 <- df %>%
filter(state == "0-15")
View(df_0_15)
rm(list=ls())
# install.packages("fastDummies")
library(welo)
library(tidyverse)
library(data.table)
library(ggplot2)
subset_m <- as.data.table(read.csv("../data/wimbledon_subset_m.csv"))
subset_f <- as.data.table(read.csv("../data/wimbledon_subset_f.csv"))
names(subset_m)
View(subset_m)
subset_m <- subset_m %>%
arrange(match_id, PointNumber) %>%
group_by(match_id) %>%
mutate(
lag_elapsed = lag(ElapsedSeconds),
time_diff = ElapsedSeconds - lag_elapsed
)
View(subset_m)
avg_diffs <- subset_m %>%
filter(!is.na(time_diff) & time_diff < 28800) %>%
group_by(match_id) %>%
summarise(avg_time_diff = mean(time_diff, na.rm = TRUE), .groups = "drop")
subset_m <- subset_m %>%
left_join(avg_diffs, by = "match_id") %>%
mutate(
ElapsedSeconds_fixed = if_else(
!is.na(time_diff) & time_diff > 28800,
lag_elapsed + avg_time_diff,
ElapsedSeconds
)
) %>%
select(-lag_elapsed, -time_diff, -avg_time_diff)
View(subset_m)
subset_m <- subset_m %>%
left_join(avg_diffs, by = "match_id") %>%
mutate(
ElapsedSeconds_fixed = if_else(
!is.na(time_diff) & ElapsedSeconds > 28800,
lag_elapsed + avg_time_diff,
ElapsedSeconds
)
) %>%
select(-lag_elapsed, -time_diff, -avg_time_diff)
View(subset_m)
subset_m <- subset_m %>%
arrange(match_id, PointNumber) %>%
group_by(match_id) %>%
mutate(
lag_elapsed = lag(ElapsedSeconds),
time_diff = ElapsedSeconds - lag_elapsed
)
avg_diffs <- subset_m %>%
filter(!is.na(time_diff) & time_diff < 28800) %>%
group_by(match_id) %>%
summarise(avg_time_diff = mean(time_diff, na.rm = TRUE), .groups = "drop")
subset_m <- subset_m %>%
left_join(avg_diffs, by = "match_id") %>%
mutate(
ElapsedSeconds_fixed = if_else(
!is.na(time_diff) & ElapsedSeconds > 28800,
lag_elapsed + avg_time_diff,
ElapsedSeconds
)
) %>%
select(-lag_elapsed, -time_diff, -avg_time_diff)
View(subset_m)
subset_m <- subset_m %>%
arrange(match_id, PointNumber) %>%
group_by(match_id) %>%
mutate(
lag_elapsed = lag(ElapsedSeconds),
time_diff = ElapsedSeconds - lag_elapsed
)
avg_diffs <- subset_m %>%
filter(!is.na(time_diff) & ElapsedSeconds < 28800) %>%
group_by(match_id) %>%
summarise(avg_time_diff = mean(time_diff, na.rm = TRUE), .groups = "drop")
subset_m <- subset_m %>%
left_join(avg_diffs, by = "match_id") %>%
mutate(
ElapsedSeconds_fixed = if_else(
!is.na(time_diff) & ElapsedSeconds > 28800,
lag_elapsed + avg_time_diff,
ElapsedSeconds
)
) %>%
select(-lag_elapsed, -time_diff, -avg_time_diff)
View(subset_m)
subset_m <- subset_m %>%
arrange(match_id, PointNumber) %>%
group_by(match_id) %>%
mutate(
lag_elapsed = lag(ElapsedSeconds),
time_diff = ElapsedSeconds - lag_elapsed
)
avg_diffs <- subset_m %>%
filter(!is.na(time_diff) & ElapsedSeconds < 28800) %>%
group_by(match_id) %>%
summarise(avg_time_diff = mean(time_diff, na.rm = TRUE), .groups = "drop")
View(avg_diffs)
subset_m <- subset_m %>%
arrange(match_id, PointNumber) %>%
group_by(match_id) %>%
mutate(
lag_elapsed = lag(ElapsedSeconds),
time_diff = ElapsedSeconds - lag_elapsed
)
rm(list=ls())
# install.packages("fastDummies")
library(welo)
library(tidyverse)
library(data.table)
library(ggplot2)
subset_m <- as.data.table(read.csv("../data/wimbledon_subset_m.csv"))
subset_f <- as.data.table(read.csv("../data/wimbledon_subset_f.csv"))
names(subset_m)
subset_m <- subset_m %>%
filter(ServeDepth != "", ServeWidth != "")
subset_f <- subset_f %>%
filter(ServeDepth != "", ServeWidth != "")
subset_m <- subset_m %>%
arrange(match_id, PointNumber) %>%
group_by(match_id) %>%
mutate(
lag_elapsed = lag(ElapsedSeconds),
time_diff = ElapsedSeconds - lag_elapsed
)
View(subset_m)
avg_diffs <- subset_m %>%
filter(!is.na(time_diff) & ElapsedSeconds < 28800) %>%
group_by(match_id) %>%
summarise(avg_time_diff = mean(time_diff, na.rm = TRUE), .groups = "drop")
View(avg_diffs)
subset_m <- subset_m %>%
left_join(avg_diffs, by = "match_id") %>%
arrange(match_id, PointNumber) %>%
group_by(match_id) %>%
mutate(
ElapsedSeconds_fixed = ElapsedSeconds,
flagged = ElapsedSeconds > 28800
)
View(subset_m)
subset_m <- subset_m %>%
group_modify(~ {
df <- .x
for (i in 2:nrow(df)) {
if (df$flagged[i] || df$ElapsedSeconds_fixed[i] > 28800) {
df$ElapsedSeconds_fixed[i] <- df$ElapsedSeconds_fixed[i - 1] + df$avg_time_diff[i]
df$flagged[i] <- TRUE
}
}
df
}) %>%
ungroup() %>%
select(-lag_elapsed, -time_diff, -avg_time_diff, -flagged)
df$flagged
subset_m$flagged
for (i in 2:nrow(subset_m)) {
if (subset_m$flagged[i] || subset_m$ElapsedSeconds_fixed[i] > 28800) {
subset_m$ElapsedSeconds_fixed[i] <- subset_m$ElapsedSeconds_fixed[i - 1] + subset_m$avg_time_diff[i]
subset_m$flagged[i] <- TRUE
}
}
subset_m$ElapsedSeconds_fixed
rm(list=ls())
# install.packages("fastDummies")
library(welo)
library(tidyverse)
library(data.table)
library(ggplot2)
subset_m <- as.data.table(read.csv("../data/wimbledon_subset_m.csv"))
subset_f <- as.data.table(read.csv("../data/wimbledon_subset_f.csv"))
names(subset_m)
subset_m <- subset_m %>%
filter(ServeDepth != "", ServeWidth != "")
subset_f <- subset_f %>%
filter(ServeDepth != "", ServeWidth != "")
subset_m <- subset_m %>%
arrange(match_id, PointNumber) %>%
group_by(match_id) %>%
mutate(
lag_elapsed = lag(ElapsedSeconds),
time_diff = ElapsedSeconds - lag_elapsed
)
# avg difference in between points before the large jump (if any)
avg_diffs <- subset_m %>%
filter(!is.na(time_diff) & ElapsedSeconds < 28800) %>%
group_by(match_id) %>%
summarise(avg_time_diff = mean(time_diff, na.rm = TRUE), .groups = "drop")
subset_m <- subset_m %>%
left_join(avg_diffs, by = "match_id") %>%
arrange(match_id, PointNumber) %>%
group_by(match_id) %>%
mutate(
ElapsedSeconds_fixed = ElapsedSeconds,
flagged = ElapsedSeconds > 28800
)
for (i in 2:nrow(subset_m)) {
if (subset_m$flagged[i] || subset_m$ElapsedSeconds_fixed[i] > 28800) {
subset_m$ElapsedSeconds_fixed[i] <- subset_m$ElapsedSeconds_fixed[i - 1] + subset_m$avg_time_diff[i]
subset_m$flagged[i] <- TRUE
}
}
subset_m$flagged
subset_m$ElapsedSeconds_fixed[i]
subset_m$ElapsedSeconds_fixed
View(subset_m)
for (i in 3:nrow(subset_m)) {
if (subset_m$flagged[i] || subset_m$ElapsedSeconds_fixed[i] > 28800) {
subset_m$ElapsedSeconds_fixed[i] <- subset_m$ElapsedSeconds_fixed[i - 1] + subset_m$avg_time_diff[i]
subset_m$flagged[i] <- TRUE
}
}
# find nas in each column
sum(is.na(subset_m))
# find nas in each column
colSums(is.na(subset_m))
subset_m_na <- subset_m %>%
filter(is.na(ElapsedSeconds_fixed) | is.na(flagged))
View(subset_m_na)
subset_m <- subset_m %>%
mutate(ElapsedSeconds = as.numeric(
as.difftime(ElapsedTime, format = "%H:%M:%S", units = "secs")
))
# find nas in each column
colSums(is.na(subset_m))
as.numeric(as.difftime("31:29:02", format = "%H:%M:%S", units = "secs")
test <- as.numeric(as.difftime("31:29:02", format = "%H:%M:%S", units = "secs")
test <- as.numeric(as.difftime("23:29:02", format = "%H:%M:%S", units = "secs")
test <- as.numeric(as.difftime("23:29:02", format = "%H:%M:%S", units = "secs"))
library(hms)
test <- as.numeric(as_hms("23:29:02"))
test <- as.numeric(as_hms("25:29:02"))
time <- strptime("23:29:02", format = "%H:%M:%S")
test <- as.numeric(difftime(time, as.POSIXct("00:00:00", format = "%H:%M:%S"), units = "secs"))
time <- strptime("25:29:02", format = "%H:%M:%S")
test <- as.numeric(difftime(time, as.POSIXct("00:00:00", format = "%H:%M:%S"), units = "secs"))
