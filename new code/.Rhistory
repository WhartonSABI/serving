# Set up data for the plot
data_list <- list()
# Add the mother wavelet to the data
mother_wavelet <- data.frame(t = t_vals, H_t = sapply(t_vals, H), wavelet = "Mother Wavelet")
data_list[[1]] <- mother_wavelet
# Add the wavelets H_n(t) to the data
for (n in 1:n_max) {
j <- floor(log2(n))
k <- n - 2^j
wavelet_vals <- sapply(t_vals, H_n, j = j, k = k)
wavelet_data <- data.frame(t = t_vals, H_t = wavelet_vals, wavelet = paste("H_", n, "(t)", sep = ""))
data_list[[n + 1]] <- wavelet_data
}
# Combine the data into one data frame
all_data <- bind_rows(data_list)
# Create the ggplot
p <- ggplot(all_data, aes(x = t, y = H_t, color = wavelet, linetype = wavelet)) +
geom_line(size = 1) +
scale_color_manual(values = c("blue", rainbow(n_max))) +  # Set custom colors
labs(title = paste("Mother Wavelet and H_n(t) for n = 1 to", n_max),
x = "t", y = "H(t)", color = "Wavelet") +
theme_minimal() +
theme(legend.position = "top", legend.box = "horizontal", legend.box.spacing = unit(0.5, "cm"))
# Print the plot
print(p)
}
# Example: Plot H_n(t) for n from 1 to 8 with different colors
plot_wavelets(8)
# Example: Plot H_n(t) for n from 1 to 8 with different colors
plot_wavelets(4)
## clear environment (if desired)
rm(list=ls())
library(ggplot2)
library(dplyr)
# Define the "mother wavelet" H(t)
H <- function(t) {
if (t >= 0 && t < 0.5) {
return(1)
} else if (t >= 0.5 && t <= 1) {
return(-1)
} else {
return(0)
}
}
# Define the sequence of functions H_n(t)
H_n <- function(t, j, k) {
return(2^(j/2) * H(2^j * t - k))
}
# Plotting function using ggplot2
plot_wavelets <- function(n_max) {
t_vals <- seq(0, 1, length.out = 1000)
# Set up data for the plot
data_list <- list()
# Add the mother wavelet to the data
mother_wavelet <- data.frame(t = t_vals, H_t = sapply(t_vals, H), wavelet = "Mother Wavelet")
data_list[[1]] <- mother_wavelet
# Add the wavelets H_n(t) to the data
for (n in 1:n_max) {
j <- floor(log2(n))
k <- n - 2^j
wavelet_vals <- sapply(t_vals, H_n, j = j, k = k)
wavelet_data <- data.frame(t = t_vals, H_t = wavelet_vals, wavelet = paste("H_", n, "(t)", sep = ""))
data_list[[n + 1]] <- wavelet_data
}
# Combine the data into one data frame
all_data <- bind_rows(data_list)
# Create the ggplot
p <- ggplot(all_data, aes(x = t, y = H_t, color = wavelet, linetype = wavelet)) +
geom_line(size = 1) +
scale_color_manual(values = c("blue", rainbow(n_max))) +  # Set custom colors
labs(title = paste("Mother Wavelet and H_n(t) for n = 1 to", n_max),
x = "t", y = "H(t)", color = "Wavelet") +
theme_minimal() +
theme(legend.position = "top", legend.box = "horizontal", legend.box.spacing = unit(0.5, "cm"))
# Print the plot
print(p)
}
# Example: Plot H_n(t) for n from 1 to 8 with different colors
plot_wavelets(7)
# Define the triangle function Delta(t)
Delta <- function(t) {
if (t >= 0 && t < 0.5) {
return(2 * t)
} else if (t >= 0.5 && t <= 1) {
return(2 * (1 - t))
} else {
return(0)
}
}
# Define the sequence of functions Delta_n(t)
Delta_n <- function(t, j, k) {
ifelse(t==0, return(t), return(Delta(2^j * t - k)))
}
# Plotting function using ggplot2
plot_triangle_wavelets <- function(n_max) {
t_vals <- seq(0, 1, length.out = 1000)
# Set up data for the plot
data_list <- list()
# Add the mother wavelet (Delta(t)) to the data--i think mother wavelet is same as delta_1
mother_wavelet <- data.frame(t = t_vals, Delta_t = sapply(t_vals, Delta), wavelet = "Mother Wavelet")
data_list[[1]] <- mother_wavelet
# Add the functions Delta_n(t) for n = 1 to n_max
for (n in 1:n_max) {
j <- floor(log2(n))
k <- n - 2^j
wavelet_vals <- sapply(t_vals, Delta_n, j = j, k = k)
wavelet_data <- data.frame(t = t_vals, Delta_t = wavelet_vals, wavelet = paste("Delta_", n, "(t)", sep = ""))
data_list[[n + 2]] <- wavelet_data
}
# Combine the data into one data frame
all_data <- bind_rows(data_list)
# Create the ggplot
p <- ggplot(all_data, aes(x = t, y = Delta_t, color = wavelet, linetype = wavelet)) +
geom_line(size = 1) +
scale_color_manual(values = c("blue", rainbow(n_max + 1))) +  # Set custom colors (blue for mother wavelet)
labs(title = paste("Delta_n(t) and Mother Wavelet for n = 0 to", n_max),
x = "t", y = "Delta(t)", color = "Wavelet") +
theme_minimal() +
theme(legend.position = "top", legend.box = "horizontal", legend.box.spacing = unit(0.5, "cm"))
# Print the plot
print(p)
}
# Example: Plot Delta_n(t) for n from 0 to 7 with different colors and including the mother wavelet
plot_triangle_wavelets(7)
# Define lambda_n calculation
lambda_n <- function(n) {
if (n == 0) {
return(1)
} else {
j <- floor(log2(n))  # This corresponds to the j value for n = 2^j + k
return(1/2 * 2^(-j/2))
}
}
# Define X_t as the sum of terms for each t
X_t <- function(t, n_max) {
Xt_sum <- 0
for (n in 0:n_max) {
j <- floor(log2(n))
k <- n - 2^j
lambda_n_value <- lambda_n(n)
Z_n <- rnorm(1)  # Generating standard normal random variable
Xt_sum <- Xt_sum + lambda_n_value * Z_n * Delta_n(t, j, k)
}
return(Xt_sum)
}
# Plotting function
plot_X_t <- function(n_max) {
t_vals <- seq(0, 1, length.out = 1000)
# Compute X_t for each t value
Xt_vals <- sapply(t_vals, X_t, n_max = n_max)
# Create the data frame for ggplot
data <- data.frame(t = t_vals, X_t = Xt_vals)
# Create the ggplot
p <- ggplot(data, aes(x = t, y = X_t)) +
geom_line(size = 1) +
labs(title = paste("X_t for n = 0 to", n_max),
x = "t", y = "X_t") +
theme_minimal()
# Print the plot
print(p)
}
# Example: Plot X_t for n from 0 to 8
plot_X_t(7)
# Plotting function
plot_X_t <- function(n_max) {
t_vals <- seq(0, 1, length.out = 16)
# Compute X_t for each t value
Xt_vals <- sapply(t_vals, X_t, n_max = n_max)
# Create the data frame for ggplot
data <- data.frame(t = t_vals, X_t = Xt_vals)
# Create the ggplot
p <- ggplot(data, aes(x = t, y = X_t)) +
geom_line(size = 1) +
labs(title = paste("X_t for n = 0 to", n_max),
x = "t", y = "X_t") +
theme_minimal()
# Print the plot
print(p)
}
# Example: Plot X_t for n from 0 to 8
plot_X_t(7)
# Plotting function
plot_X_t <- function(n_max) {
t_vals <- seq(0, 1, length.out = 1000)
# Compute X_t for each t value
Xt_vals <- sapply(t_vals, X_t, n_max = n_max)
# Create the data frame for ggplot
data <- data.frame(t = t_vals, X_t = Xt_vals)
# Create the ggplot
p <- ggplot(data, aes(x = t, y = X_t)) +
geom_line(size = 1) +
labs(title = paste("X_t for n = 0 to", n_max),
x = "t", y = "X_t") +
theme_minimal()
# Print the plot
print(p)
}
# Example: Plot X_t for n from 0 to 8
plot_X_t(7)
# Plotting function using ggplot2
plot_wavelets <- function(n_max) {
t_vals <- seq(0, 1, length.out = 1000)
# Set up data for the plot
data_list <- list()
# Add the mother wavelet to the data
mother_wavelet <- data.frame(t = t_vals, H_t = sapply(t_vals, H), wavelet = "Mother Wavelet")
data_list[[1]] <- mother_wavelet
# Add the wavelets H_n(t) to the data
for (n in 1:n_max) {
j <- floor(log2(n))
k <- n - 2^j
wavelet_vals <- sapply(t_vals, H_n, j = j, k = k)
wavelet_data <- data.frame(t = t_vals, H_t = wavelet_vals, wavelet = paste("H_", n, "(t)", sep = ""))
data_list[[n + 1]] <- wavelet_data
}
# Combine the data into one data frame
all_data <- bind_rows(data_list)
# Create the ggplot
p <- ggplot(all_data, aes(x = t, y = H_t, color = wavelet, linetype = wavelet)) +
geom_line(size = 1) +
scale_color_manual(values = c("blue", rainbow(n_max))) +  # Set custom colors
labs(title = paste("Mother Wavelet and H_n(t) for n = 1 to", n_max),
x = "t", y = "H(t)", color = "Wavelet") +
theme_minimal() +
theme(legend.position = "top", legend.box = "horizontal", legend.box.spacing = unit(0.5, "cm"))
# Print the plot
print(p)
}
# Example: Plot H_n(t) for n from 1 to 8 with different colors
plot_wavelets(3)
p_be <- 11 / 21
z <- qnorm(0.975)
p_values <- seq(p_BE + 1e-4, 1, length.out = 100)
p_values <- seq(p_be + 1e-4, 1, length.out = 100)
n_required <- numeric(length(p_values))
for (i in 1:length(p_values)) {
p <- p_values[i]
num <- z * sqrt(p * (1 - p))
denom <- p - p_BE
n_required[i] <- ceiling((num / denom)^2)
}
for (i in 1:length(p_values)) {
p <- p_values[i]
num <- z * sqrt(p * (1 - p))
denom <- p - p_be
n_required[i] <- ceiling((num / denom)^2)
}
# dataframe for lpotting
plot_data <- data.frame(
p = p_values,
n = n_required
)
ggplot(plot_data, aes(x = p, y = n)) +
geom_line(color = "blue", size = 1) +
geom_vline(xintercept = p_be, linetype = "dashed", color = "red") +
labs(title = "Number of Bets Needed for 95% Confidence of Profitability",
x = "True Success Rate (p)",
y = "Minimum Bets Needed (n)") +
theme_minimal()
# install.packages(c("ggplot2", "tidyverse"))
library(ggplot2)
library(tidyverse)
library(broom)
ggplot(plot_data, aes(x = p, y = n)) +
geom_line(color = "blue", size = 1) +
geom_vline(xintercept = p_be, linetype = "dashed", color = "red") +
labs(title = "Number of Bets Needed for 95% Confidence of Profitability",
x = "True Success Rate (p)",
y = "Minimum Bets Needed (n)") +
theme_minimal()
n_required
View(plot_data)
rm(list = ls())
library(data.table)
library(tidyverse)      # dplyr, purrr, tibble, ggplot2
library(e1071)          # svm()
library(yardstick)      # accuracy_vec(), mn_log_loss_vec()
library(viridisLite)    # nice continuous palettes (scale_fill_viridis_c)
setwd("C:/UPenn/tennis_wsabi/new code")
## ---------------------------------------------------------------------
## 1.  paths ------------------------------------------------------------
paths <- list(
wimb_m_train = "scaled/wimbledon_m_train_scaled.csv",
wimb_f_train = "scaled/wimbledon_f_train_scaled.csv",
uso_m_train  = "scaled/usopen_m_train_scaled.csv",
uso_f_train  = "scaled/usopen_f_train_scaled.csv",
wimb_m_test  = "scaled/wimbledon_m_test_scaled.csv",
wimb_f_test  = "scaled/wimbledon_f_test_scaled.csv",
uso_m_test   = "scaled/usopen_m_test_scaled.csv",
uso_f_test   = "scaled/usopen_f_test_scaled.csv"
)
## ---------------------------------------------------------------------
## 1.  paths ------------------------------------------------------------
paths <- list(
wimb_m_train = "scaled/wimbledon_m_train_scaled.csv",
wimb_f_train = "scaled/wimbledon_f_train_scaled.csv",
uso_m_train  = "scaled/usopen_m_train_scaled.csv",
uso_f_train  = "scaled/usopen_f_train_scaled.csv",
wimb_m_test  = "scaled/wimbledon_m_test_scaled.csv",
wimb_f_test  = "scaled/wimbledon_f_test_scaled.csv",
uso_m_test   = "scaled/usopen_m_test_scaled.csv",
uso_f_test   = "scaled/usopen_f_test_scaled.csv"
)
## ---------------------------------------------------------------------
## 2.  helper: build & save a 2-D decision plot ------------------------
plot_svm_2d <- function(best_mod, train_df, speed_var,
plot_dir, file_stub,
grid_pts = 100) {
plot_var <- "importance"
# sequences for 2-D grid
sx <- seq(min(train_df[[speed_var]], na.rm = TRUE),
max(train_df[[speed_var]], na.rm = TRUE),
length.out = grid_pts)
sy <- seq(min(train_df[[plot_var]], na.rm = TRUE),
max(train_df[[plot_var]], na.rm = TRUE),
length.out = grid_pts)
grid <- expand.grid(sx, sy)
names(grid) <- c(speed_var, plot_var)
## ---- hold all other predictors at typical values ------------------
grid$ElapsedSeconds_fixed     <- median(train_df$ElapsedSeconds_fixed, na.rm = TRUE)
grid$p_server_beats_returner  <- median(train_df$p_server_beats_returner, na.rm = TRUE)
grid$ServeWidth               <- factor(levels(train_df$ServeWidth)[1],
levels = levels(train_df$ServeWidth))
grid$ServeDepth               <- factor(levels(train_df$ServeDepth)[1],
levels = levels(train_df$ServeDepth))
## ---- predict probability -----------------------------------------
grid$prob <- attr(predict(best_mod, grid, probability = TRUE),
"probabilities")[, "1"]
## ---- sample some training pts for overlay -------------------------
pts <- train_df %>%
select(all_of(c(speed_var, plot_var, "server_win"))) %>%
sample_n(min(1000, n()))
p <- ggplot(grid, aes_string(speed_var, plot_var)) +
geom_raster(aes(fill = prob), interpolate = TRUE) +
scale_fill_viridis_c(name = "P(win)", option = "D") +
geom_point(data = pts,
aes_string(speed_var, plot_var,
shape = "factor(server_win)"),
alpha = 0.5, size = 1) +
scale_shape_manual(values = c(1, 17), name = "Actual") +
labs(x = speed_var, y = "importance",
title = file_stub) +
theme_minimal(base_size = 10)
ggsave(filename = file.path(plot_dir, paste0(file_stub, ".png")),
plot     = p,
width    = 5, height = 4, dpi = 300)
}
#
#     tibble(
#       speed_var = spd,
#       cost      = tuned$best.parameters$cost,
#       gamma     = tuned$best.parameters$gamma,
#       accuracy  = accuracy_vec(truth_f, test_pred),
#       log_loss  = mn_log_loss_vec(truth_f, test_prob)
#     )
#   })
# }
run_svm_fast <- function(train_df, test_df,
y           = "server_win",
speed_vars  = c("Speed_MPH", "speed_ratio"),
other_vars,
cost_grid   = 2 ^ seq(-5, 9, by = 2),   # 6 values
gamma_grid  = 2 ^ seq(-8, 2, by = 2),   # 6 values
subsample   = 0.15,                     # A: 15 % sample
plot_dir,
file_prefix) {
map_dfr(speed_vars, function(spd) {
## ------------------------------ 0. subsample for tuning (A)
idx_tune <- sample.int(nrow(train_df),
size = ceiling(nrow(train_df) * subsample))
tune_df  <- train_df[idx_tune, ]
fml <- as.formula(paste(y, "~", paste(c(spd, other_vars), collapse = " + ")))
## ------------------------------ 1. coarse 3 × 3 grid (B)
coarse <- tune(
svm, fml,
data   = tune_df,
kernel = "radial",
ranges = list(
cost  = cost_grid [c(1, 4, 6)],   # 2^-5 , 2^3 , 2^9
gamma = gamma_grid[c(1, 3, 6)]    # 2^-8 , 2^-4, 2^2
),
cross  = 3,
probability = TRUE,                 # ← keep probabilities
# uncomment next line for parallel CV (C)
# tunecontrol = tune.control(cross = 3, allowParallel = TRUE)
)
## ------------------------------ 2. fine 3 × 3 grid around winner (B)
fine <- tune(
svm, fml,
data   = tune_df,
kernel = "radial",
ranges = list(
cost  = coarse$best.parameters$cost  * c(0.25, 1, 4),
gamma = coarse$best.parameters$gamma * c(0.25, 1, 4)
),
cross  = 3,
probability = TRUE
)
## ------------------------------ 3. refit once on full training set (A)
best <- svm(
fml, data = train_df,
kernel      = "radial",
cost        = fine$best.parameters$cost,
gamma       = fine$best.parameters$gamma,
probability = TRUE
)
## ------------------------------ 4. evaluate
test_prob <- attr(predict(best, test_df, probability = TRUE),
"probabilities")[, "1"]
test_pred <- factor(test_prob > 0.5, levels = c(FALSE, TRUE))
truth_f   <- factor(test_df[[y]] > 0,  levels = c(FALSE, TRUE))
## (optional) decision-surface plot on the smaller tune_df
plot_svm_2d(best, train_df = tune_df,
speed_var = spd,
plot_dir  = plot_dir,
file_stub = paste0(file_prefix, "_", spd))
tibble(
speed_var = spd,
cost      = best$cost,
gamma     = attr(best, "gamma"),
accuracy  = accuracy_vec(truth_f, test_pred),
log_loss  = mn_log_loss_vec(truth_f, test_prob)
)
})
}
## ---------------------------------------------------------------------
## 4.  common predictors -----------------------------------------------
other_predictors <- c(
"importance",
"p_server_beats_returner",
"ServeWidth",
"ServeDepth",
"ElapsedSeconds_fixed"
)
## ---------------------------------------------------------------------
## 5.  experiment design (8 splits) ------------------------------------
exp_grid <- tribble(
~set_name,  ~train_path,           ~test_path,            ~serve_type,
"wimb_m_1", paths$wimb_m_train,    paths$wimb_m_test,     1,
"wimb_m_2", paths$wimb_m_train,    paths$wimb_m_test,     0,
"wimb_f_1", paths$wimb_f_train,    paths$wimb_f_test,     1,
"wimb_f_2", paths$wimb_f_train,    paths$wimb_f_test,     0,
"uso_m_1",  paths$uso_m_train,     paths$uso_m_test,      1,
"uso_m_2",  paths$uso_m_train,     paths$uso_m_test,      0,
"uso_f_1",  paths$uso_f_train,     paths$uso_f_test,      1,
"uso_f_2",  paths$uso_f_train,     paths$uso_f_test,      0
)
## ---------------------------------------------------------------------
## 6.  make a folder for plots -----------------------------------------
plot_dir <- "svm_plots"
dir.create(plot_dir, showWarnings = FALSE)
## ---------------------------------------------------------------------
## 7.  run everything ---------------------------------------------------
results_df <- pmap_dfr(
exp_grid,
function(set_name, train_path, test_path, serve_type) {
train_raw <- fread(train_path)
test_raw  <- fread(test_path)
train <- train_raw %>% filter(ServeNumber == serve_type)
test  <- test_raw  %>% filter(ServeNumber == serve_type)
run_svm(
train_df   = train,
test_df    = test,
y          = "serving_player_won",
speed_vars = c("Speed_MPH", "speed_ratio"),
other_vars = other_predictors,
plot_dir   = plot_dir,
file_prefix = paste0(set_name,
ifelse(serve_type == 1, "_first", "_second"))
) %>%
mutate(data_set   = set_name,
serve_type = ifelse(serve_type == 1, "first", "second"),
.before = 1)
}
)
run_svm_fast(
train_df   = train,
test_df    = test,
y          = "serving_player_won",
speed_vars = c("Speed_MPH", "speed_ratio"),
other_vars = other_predictors,
plot_dir   = plot_dir,
file_prefix = paste0(set_name,
ifelse(serve_type == 1, "_first", "_second"))
) %>%
mutate(data_set   = set_name,
serve_type = ifelse(serve_type == 1, "first", "second"),
.before = 1)
## ---------------------------------------------------------------------
## 7.  run everything ---------------------------------------------------
results_df <- pmap_dfr(
exp_grid,
function(set_name, train_path, test_path, serve_type) {
train_raw <- fread(train_path)
test_raw  <- fread(test_path)
train <- train_raw %>% filter(ServeNumber == serve_type)
test  <- test_raw  %>% filter(ServeNumber == serve_type)
run_svm_fast(
train_df   = train,
test_df    = test,
y          = "serving_player_won",
speed_vars = c("Speed_MPH", "speed_ratio"),
other_vars = other_predictors,
plot_dir   = plot_dir,
file_prefix = paste0(set_name,
ifelse(serve_type == 1, "_first", "_second"))
) %>%
mutate(data_set   = set_name,
serve_type = ifelse(serve_type == 1, "first", "second"),
.before = 1)
}
)
